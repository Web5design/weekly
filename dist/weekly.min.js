/*!
 * weekly - jQuery Weekly Calendar Plugin
 * v0.1.0
 * https://github.com/jgallen23/weekly
 * copyright Greg Allen 2013
 * MIT License
*/
!function(a){a.declare("weekly",{defaults:{startTime:8,endTime:6,weekOffset:0,currentDate:new Date,autoRender:!0,template:'<div class="days"><% for (var i = 0; i < dates.length; i++) { var date = dates[i]; %>  <div class="day" style="width:<%= 100/dates.length %>%" data-date="<%= date.getFullYear() %>-<%= date.getMonth() %>-<%= date.getDate() %>"><%= date.toDateString() %></div><% } %></div><div class="times"><% for (var i = 0; i < times.length; i++) { var time = times[i]; %>  <div class="time" data-time="<%= time %>"><%= time %></div><% } %></div><div class="grid"><% for (var i = 0; i < dates.length; i++) { var date = dates[i]; %>  <div class="day" style="width:<%= 100/dates.length %>%" data-date="<%= date.getFullYear() %>-<%= date.getMonth() %>-<%= date.getDate() %>">    <% for (var ii = 0; ii < times.length; ii++) { var time = times[ii]; %>      <div class="time" data-time="<%= time %>">&nbsp;</div>    <% } %>  </div><% } %></div>'},init:function(){this.events=[],this.autoRender&&this.update()},update:function(){this.render({dates:this.getDates(),times:this.getTimes()}),this.timeDifference=this.endTime+13-this.startTime,this.registerClickToCreate()},registerClickToCreate:function(){this.mouseDown=!1,this.pendingEvent=null,this.pendingEventStart=null;var b=this.el.find(".grid .day");b.unbind("mousedown mousemove mouseup mouseout"),b.on("mousedown",this.proxy(function(){this.mouseDown=!0,this.pendingEvent&&(this.pendingEvent.remove(),this.pendingEvent=null)})),b.on("mouseup",this.proxy(function(){this.mouseDown=!1;var a=this.pendingEvent.data(),b=a.date.split("-");this.addEvent({start:new Date(b[0],b[1],b[2],a.starttime),end:new Date(b[0],b[1],b[2],a.endtime)}),this.el.trigger("addEvent",[a]),this.pendingEvent.remove(),this.pendingEvent=null,this.pendingEventStart=null})),b.on("mousemove",this.proxy(function(b){if(this.mouseDown){var c=a(b.currentTarget),d=c.offset(),e=b.clientY-d.top,f=a(b.currentTarget).height(),g=Math.round(f/this.timeDifference),h=Math.floor(e/g)*g,i=Math.ceil(e/g)*g;null===this.pendingEventStart&&(this.pendingEventStart=h),(null===this.pendingEventEnd||i>this.pendingEventStart)&&(this.pendingEventEnd=i),this.pendingEvent||(c.append('<div class="event-pending"></div>'),this.pendingEvent=c.find(".event-pending"),this.pendingEvent.data("date",c.data("date"))),this.pendingEvent.css({top:this.pendingEventStart,bottom:f-this.pendingEventEnd}),this.pendingEvent.data("starttime",(this.pendingEventStart/g||0)+this.startTime),this.pendingEvent.data("endtime",(this.pendingEventEnd/g||1)+this.startTime)}})),b.on("mouseleave",this.proxy(function(){this.mouseDown&&b.trigger("mouseup")}))},getDates:function(){for(var a=this.currentDate,b=a.getDate()-a.getDay(),c=7,d=[],e=new Date(a.setDate(b+this.weekOffset*c)),f=0,g=c;g>f;f++){var h=new Date(e.setDate(e.getDate()-e.getDay()+f));d.push(h)}return d},getTimes:function(){for(var a=this.endTime+12,b=[],c=this.startTime;a>=c;c++){var d=c>12?c-12:c,e=d+":00 ";e+=c>11?"PM":"AM",b.push(e)}return b},renderEvent:function(b){var c=b.start.getFullYear()+"-"+b.start.getMonth()+"-"+b.start.getDate(),d=b.start.toTimeString().slice(0,5);b.end.getFullYear()+"-"+b.end.getMonth()+"-"+b.end.getDate();var e=b.end.toTimeString().slice(0,5),f=100-this.getTimeOffsetPercent(d),g=this.getTimeOffsetPercent(e),h=a('<div class="event"></div>');h.css({top:f+"%",bottom:g+"%"}).append('<div class="event-title">'+d+'</div><div class="event-name">'+b.name+'</div><div class="event-desc">'+b.description+"</div>"),this.el.find('.grid .day[data-date="'+c+'"]').append(h)},toFraction:function(a){if(-1===a.toString().indexOf(":"))return a;var b=a.toString().split(":");return parseFloat(b[0]+"."+100/(60/b[1]))},getTimeOffsetPercent:function(a){a=this.toFraction(a)-this.startTime;var b=this.timeDifference-a;0>b&&(b=a-this.timeDifference);var c=100*(b/this.timeDifference);return c},addEvent:function(b){b=a.extend({name:"",description:"",start:null,end:null},b),this.renderEvent(b),this.events.push(b)}})}(jQuery);